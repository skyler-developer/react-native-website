/*! For license information please see e19eb737.5459c935.js.LICENSE.txt */
"use strict";(self.webpackChunkreact_native_website=self.webpackChunkreact_native_website||[]).push([[16768],{38058:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>t,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>c});var o=r(24246),s=r(71670);const i={id:"profile-hermes",title:"\u5728 Hermes \u4e2d\u8fdb\u884c\u6027\u80fd\u5206\u6790"},t=void 0,a={id:"profile-hermes",title:"\u5728 Hermes \u4e2d\u8fdb\u884c\u6027\u80fd\u5206\u6790",description:"\u4f60\u53ef\u4ee5\u4f7f\u7528Hermes\u5728React Native\u5e94\u7528\u4e2d\u53ef\u89c6\u5316JavaScript\u7684\u6027\u80fd\u3002Hermes\u662f\u4e00\u4e2a\u5c0f\u578b\u4e14\u8f7b\u91cf\u7684JavaScript\u5f15\u64ce\uff08\u4f60\u53ef\u4ee5\u5728\u8fd9\u91cc\u9605\u8bfb\u66f4\u591a\u6709\u5173\u5728React Native\u4e2d\u4f7f\u7528\u5b83\u7684\u4fe1\u606f\uff09\u3002Hermes\u6709\u52a9\u4e8e\u63d0\u9ad8\u5e94\u7528\u6027\u80fd\uff0c\u5e76\u4e14\u8fd8\u63d0\u4f9b\u4e86\u5206\u6790\u5176\u8fd0\u884c\u7684JavaScript\u6027\u80fd\u7684\u65b9\u5f0f\u3002",source:"@site/versioned_docs/version-0.74/profile-hermes.md",sourceDirName:".",slug:"/profile-hermes",permalink:"/docs/profile-hermes",draft:!1,unlisted:!1,editUrl:"https://github.com/reactnativecn/react-native-website/blob/production/cnwebsite/../cndocs/profile-hermes.md",tags:[],version:"0.74",frontMatter:{id:"profile-hermes",title:"\u5728 Hermes \u4e2d\u8fdb\u884c\u6027\u80fd\u5206\u6790"},sidebar:"docs",previous:{title:"Profiling",permalink:"/docs/profiling"},next:{title:"JavaScript \u73af\u5883",permalink:"/docs/javascript-environment"}},l={},c=[{value:"Record a Hermes sampling profile",id:"record-a-hermes-sampling-profile",level:2},{value:"Execute command from CLI",id:"execute-command-from-cli",level:2},{value:"Enabling source map",id:"enabling-source-map",level:3},{value:"Common errors",id:"common-errors",level:3},{value:"<code>adb: no devices/emulators found</code> or <code>adb: device offline</code>",id:"adb-no-devicesemulators-found-or-adb-device-offline",level:4},{value:"<code>There is no file in the cache/ directory</code>",id:"there-is-no-file-in-the-cache-directory",level:4},{value:"<code>Error: your_profile_name.cpuprofile is an empty file</code>",id:"error-your_profile_namecpuprofile-is-an-empty-file",level:4},{value:"Open the downloaded profile in Chrome DevTools",id:"open-the-downloaded-profile-in-chrome-devtools",level:2},{value:"How does the Hermes Profile Transformer work?",id:"how-does-the-hermes-profile-transformer-work",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["\u4f60\u53ef\u4ee5\u4f7f\u7528",(0,o.jsx)(n.a,{href:"https://github.com/facebook/hermes",children:"Hermes"}),"\u5728React Native\u5e94\u7528\u4e2d\u53ef\u89c6\u5316JavaScript\u7684\u6027\u80fd\u3002Hermes\u662f\u4e00\u4e2a\u5c0f\u578b\u4e14\u8f7b\u91cf\u7684JavaScript\u5f15\u64ce\uff08\u4f60\u53ef\u4ee5",(0,o.jsx)(n.a,{href:"hermes",children:"\u5728\u8fd9\u91cc\u9605\u8bfb\u66f4\u591a\u6709\u5173\u5728React Native\u4e2d\u4f7f\u7528\u5b83\u7684\u4fe1\u606f"}),"\uff09\u3002Hermes\u6709\u52a9\u4e8e\u63d0\u9ad8\u5e94\u7528\u6027\u80fd\uff0c\u5e76\u4e14\u8fd8\u63d0\u4f9b\u4e86\u5206\u6790\u5176\u8fd0\u884c\u7684JavaScript\u6027\u80fd\u7684\u65b9\u5f0f\u3002"]}),"\n",(0,o.jsxs)(n.p,{children:["\u5728\u672c\u8282\u4e2d\uff0c\u60a8\u5c06\u5b66\u4e60\u5982\u4f55\u5bf9\u5728Hermes\u4e0a\u8fd0\u884c\u7684React Native\u5e94\u7528\u8fdb\u884c\u5206\u6790\uff0c\u5e76\u5982\u4f55\u4f7f\u7528",(0,o.jsx)(n.a,{href:"https://developers.google.com/web/tools/chrome-devtools/evaluate-performance/reference",children:"Chrome DevTools\u4e0a\u7684\u6027\u80fd\u9009\u9879\u5361"}),"\u53ef\u89c6\u5316\u914d\u7f6e\u6587\u4ef6\u3002"]}),"\n",(0,o.jsx)(n.admonition,{title:"\u6ce8\u610f",type:"caution",children:(0,o.jsxs)(n.p,{children:["Be sure to ",(0,o.jsx)(n.a,{href:"Hermes",children:"enable Hermes in your app"})," before you get started!"]})}),"\n",(0,o.jsx)(n.p,{children:"Follow the instructions below to get started profiling:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/profile-hermes#record-a-hermes-sampling-profile",children:"Record a Hermes sampling profile"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/profile-hermes#execute-command-from-cli",children:"Execute command from CLI"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/profile-hermes#open-the-downloaded-profile-on-chrome-devtools",children:"Open the downloaded profile on Chrome DevTools"})}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"record-a-hermes-sampling-profile",children:"Record a Hermes sampling profile"}),"\n",(0,o.jsx)(n.p,{children:"To record a sampling profiler from the Dev Menu:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Navigate to your running Metro server terminal."}),"\n",(0,o.jsxs)(n.li,{children:["Press ",(0,o.jsx)(n.code,{children:"d"})," to open the ",(0,o.jsx)(n.strong,{children:"Dev Menu."})]}),"\n",(0,o.jsxs)(n.li,{children:["Select ",(0,o.jsx)(n.strong,{children:"Enable Sampling Profiler."})]}),"\n",(0,o.jsx)(n.li,{children:"Execute your JavaScript by in your app (press buttons, etc.)"}),"\n",(0,o.jsxs)(n.li,{children:["Open the ",(0,o.jsx)(n.strong,{children:"Dev Menu"})," by pressing ",(0,o.jsx)(n.code,{children:"d"})," again."]}),"\n",(0,o.jsxs)(n.li,{children:["Select ",(0,o.jsx)(n.strong,{children:"Disable Sampling Profiler"})," to stop recording and save the sampling profiler."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["A toast will show the location where the sampling profiler has been saved, usually in ",(0,o.jsx)(n.code,{children:"/data/user/0/com.appName/cache/*.cpuprofile"})]}),"\n",(0,o.jsx)("img",{src:"/docs/assets/HermesProfileSaved.png",height:"465",width:"250",alt:"Toast Notification of Profile saving"}),"\n",(0,o.jsx)(n.h2,{id:"execute-command-from-cli",children:"Execute command from CLI"}),"\n",(0,o.jsxs)(n.p,{children:["You can use the ",(0,o.jsx)(n.a,{href:"https://github.com/react-native-community/cli",children:"React Native CLI"})," to convert the Hermes tracing profile to Chrome tracing profile, and then pull it to your local machine using:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"npx react-native profile-hermes [destinationDir]\n"})}),"\n",(0,o.jsx)(n.h3,{id:"enabling-source-map",children:"Enabling source map"}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsxs)(n.p,{children:["You may read about source maps on the ",(0,o.jsx)(n.a,{href:"/docs/debugging-release-builds",children:"Debugging Release Builds"})," page."]})}),"\n",(0,o.jsx)(n.h3,{id:"common-errors",children:"Common errors"}),"\n",(0,o.jsxs)(n.h4,{id:"adb-no-devicesemulators-found-or-adb-device-offline",children:[(0,o.jsx)(n.code,{children:"adb: no devices/emulators found"})," or ",(0,o.jsx)(n.code,{children:"adb: device offline"})]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Why this happens"})," The CLI cannot access the device or emulator (through adb) you are using to run the app."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"How to fix"})," Make sure your Android device/emulator is connected and running. The command only works when it can access adb."]}),"\n"]}),"\n",(0,o.jsx)(n.h4,{id:"there-is-no-file-in-the-cache-directory",children:(0,o.jsx)(n.code,{children:"There is no file in the cache/ directory"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Why this happens"})," The CLI cannot find any ",(0,o.jsx)(n.strong,{children:".cpuprofile"})," file in your app's ",(0,o.jsx)(n.strong,{children:"cache/"})," directory. You might have forgotten to record a profile from the device."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"How to fix"})," Follow the ",(0,o.jsx)(n.a,{href:"/docs/profile-hermes#record-a-hermes-sampling-profile",children:"instructions"})," to enable/disable profiler from device."]}),"\n"]}),"\n",(0,o.jsx)(n.h4,{id:"error-your_profile_namecpuprofile-is-an-empty-file",children:(0,o.jsx)(n.code,{children:"Error: your_profile_name.cpuprofile is an empty file"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Why this happens"})," The profile is empty, it might be because Hermes is not running correctly."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"How to fix"})," Make sure your app is running on the latest version of Hermes."]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"open-the-downloaded-profile-in-chrome-devtools",children:"Open the downloaded profile in Chrome DevTools"}),"\n",(0,o.jsx)(n.p,{children:"To open the profile in Chrome DevTools:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Open Chrome DevTools."}),"\n",(0,o.jsxs)(n.li,{children:["Select the ",(0,o.jsx)(n.strong,{children:"Performance"})," tab."]}),"\n",(0,o.jsxs)(n.li,{children:["Right click and choose ",(0,o.jsx)(n.strong,{children:"Load profile..."})]}),"\n"]}),"\n",(0,o.jsx)("img",{src:"/docs/assets/openChromeProfile.png",alt:"Loading a performance profile on Chrome DevTools"}),"\n",(0,o.jsx)(n.h2,{id:"how-does-the-hermes-profile-transformer-work",children:"How does the Hermes Profile Transformer work?"}),"\n",(0,o.jsxs)(n.p,{children:["The Hermes Sample Profile is of the ",(0,o.jsx)(n.code,{children:"JSON object format"}),", while the format that Google's DevTools supports is ",(0,o.jsx)(n.code,{children:"JSON Array Format"}),". (More information about the formats can be found on the ",(0,o.jsx)(n.a,{href:"https://docs.google.com/document/d/1CvAClvFfyA5R-PhYUmn5OOQtYMH4h6I0nSsKchNAySU/preview",children:"Trace Event Format Document"}),")"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:"export interface HermesCPUProfile {\n  traceEvents: SharedEventProperties[];\n  samples: HermesSample[];\n  stackFrames: {[key in string]: HermesStackFrame};\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The Hermes profile has most of its information encoded into the ",(0,o.jsx)(n.code,{children:"samples"})," and ",(0,o.jsx)(n.code,{children:"stackFrames"})," properties. Each sample is a snapshot of the function call stack at that particular timestamp as each sample has a ",(0,o.jsx)(n.code,{children:"sf"})," property which corresponds to a function call."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:"export interface HermesSample {\n  cpu: string;\n  name: string;\n  ts: string;\n  pid: number;\n  tid: string;\n  weight: string;\n  /**\n   * Will refer to an element in the stackFrames object of the Hermes Profile\n   */\n  sf: number;\n  stackFrameData?: HermesStackFrame;\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The information about a function call can be found in ",(0,o.jsx)(n.code,{children:"stackFrames"})," which contains key-object pairs, where the key is the ",(0,o.jsx)(n.code,{children:"sf"})," number and the corresponding object gives us all the relevant information about the function including the ",(0,o.jsx)(n.code,{children:"sf"})," number of its parent function. This parent-child relationship can be traced upwards to find the information of all the functions running at a particular timestamp."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:"export interface HermesStackFrame {\n  line: string;\n  column: string;\n  funcLine: string;\n  funcColumn: string;\n  name: string;\n  category: string;\n  /**\n   * A parent function may or may not exist\n   */\n  parent?: number;\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:"At this point, you should define a few more terms, namely:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Nodes: The objects corresponding to ",(0,o.jsx)(n.code,{children:"sf"})," numbers in ",(0,o.jsx)(n.code,{children:"stackFrames"})]}),"\n",(0,o.jsxs)(n.li,{children:["Active Nodes: The nodes which are currently running at a particular timestamp. A node is classified as running if its ",(0,o.jsx)(n.code,{children:"sf"})," number is in the function call stack. This call stack can be obtained from the ",(0,o.jsx)(n.code,{children:"sf"})," number of the sample and tracing upwards till parent ",(0,o.jsx)(n.code,{children:"sf"}),"s are available"]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"samples"})," and the ",(0,o.jsx)(n.code,{children:"stackFrames"})," in tandem can then be used to generate all the start and end events at the corresponding timestamps, wherein:"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Start Nodes/Events: Nodes absent in the previous sample's function call stack but present in the current sample's."}),"\n",(0,o.jsx)(n.li,{children:"End Nodes/Events: Nodes present in the previous sample's function call stack but absent in the current sample's."}),"\n"]}),"\n",(0,o.jsx)("img",{src:"/docs/assets/CallStackDemo.jpg",height:"800",width:"600",alt:"CallStack Terms Explained"}),"\n",(0,o.jsxs)(n.p,{children:["You can now construct a ",(0,o.jsx)(n.code,{children:"flamechart"})," of function calls as you have all the function information including its start and end timestamps."]}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"hermes-profile-transformer"})," can convert any profile generated using Hermes into a format that can be directly displayed in Chrome DevTools. More information about this can be found on ",(0,o.jsxs)(n.a,{href:"https://github.com/react-native-community/hermes-profile-transformer",children:[" ",(0,o.jsx)(n.code,{children:"@react-native-community/hermes-profile-transformer"})," "]})]})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},71426:(e,n,r)=>{var o=r(27378),s=Symbol.for("react.element"),i=Symbol.for("react.fragment"),t=Object.prototype.hasOwnProperty,a=o.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,l={key:!0,ref:!0,__self:!0,__source:!0};function c(e,n,r){var o,i={},c=null,d=null;for(o in void 0!==r&&(c=""+r),void 0!==n.key&&(c=""+n.key),void 0!==n.ref&&(d=n.ref),n)t.call(n,o)&&!l.hasOwnProperty(o)&&(i[o]=n[o]);if(e&&e.defaultProps)for(o in n=e.defaultProps)void 0===i[o]&&(i[o]=n[o]);return{$$typeof:s,type:e,key:c,ref:d,props:i,_owner:a.current}}n.Fragment=i,n.jsx=c,n.jsxs=c},24246:(e,n,r)=>{e.exports=r(71426)},71670:(e,n,r)=>{r.d(n,{Z:()=>a,a:()=>t});var o=r(27378);const s={},i=o.createContext(s);function t(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);